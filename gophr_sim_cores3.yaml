# Gophr Simulator - M5Stack CoreS3
# Simulates the Gophr moisture probe for HA testing
# Entity names match the real gophr.yaml device

substitutions:
  name: "gophr"
  friendly_name: "Gophr"
  software_version: "1.0.0-sim"

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"
  name_add_mac_suffix: true
  project:
    name: "FluxOpenHome.Gophr"
    version: "${software_version}"
  on_boot:
    priority: -100
    then:
      - light.turn_on:
          id: lcd_backlight
          brightness: 100%
      - lvgl.page.show:
          id: page_splash
          animation: NONE
      - delay: 3s
      - lvgl.page.show:
          id: page_main
          animation: FADE_IN
          time: 500ms
      - light.turn_on:
          id: status_led
      - lambda: |-
          id(device_awake) = true;
          id(status_led_state) = true;

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 8MB
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_INSTRUCTION_CACHE_32KB: "y"

# NOTE: Uncomment psram section below if using CoreS3 (not SE) with PSRAM
# Also add these sdkconfig_options: CONFIG_ESP32S3_DATA_CACHE_64KB,
# CONFIG_ESP32S3_DATA_CACHE_LINE_64B, CONFIG_SPIRAM_RODATA, CONFIG_SPIRAM_FETCH_INSTRUCTIONS
# psram:
#   mode: octal
#   speed: 80MHz

logger:
  level: DEBUG

api:
  id: api_server

ota:
  - platform: esphome

wifi:
  id: wifi_component
  ap:
    ssid: "${name}"
  on_connect:
    - lambda: |-
        id(wifi_sta_connected) = true;
  on_disconnect:
    - lambda: |-
        id(wifi_sta_connected) = false;

captive_portal:

esp32_improv:
  authorizer: none

web_server:
  port: 80

# ──────────────────────────────────────────────
# CoreS3 Hardware
# ──────────────────────────────────────────────

i2c:
  - id: bus_internal
    sda: GPIO12
    scl: GPIO11

spi:
  - id: spi_bus
    clk_pin: GPIO36
    mosi_pin: GPIO37

external_components:
  - source: github://m5stack/esphome-yaml/components
    components: [axp2101, aw9523b]

axp2101:
  id: axp2101_pmu
  i2c_id: bus_internal

aw9523b:
  - id: aw9523b_hub
    i2c_id: bus_internal

output:
  - platform: axp2101
    type: range
    channel: DLDO1
    id: lcd_backlight_output
    min_voltage: 2600
    max_voltage: 3300
  - platform: axp2101
    channel: ALDO1
    voltage: 1800
  - platform: axp2101
    channel: ALDO2
    voltage: 3300
  - platform: axp2101
    channel: BLDO1
    voltage: 2800
  - platform: axp2101
    channel: BLDO2
    voltage: 1500
  # Virtual output for the Status LED light entity
  - platform: template
    type: binary
    id: status_led_output
    write_action:
      - lambda: |-
          id(status_led_state) = state;

# NOTE: Copy gophr.png into your ESPHome config directory alongside this YAML
image:
  - id: gophr_logo
    file: "gophr.png"
    resize: 200x115
    type: RGB565
    transparency: alpha_channel

display:
  - platform: mipi_spi
    model: M5CORE
    dc_pin: GPIO35
    reset_pin:
      aw9523b: aw9523b_hub
      number: 9
    cs_pin: GPIO3
    data_rate: 40MHz
    invert_colors: true
    id: m5cores3_lcd
    auto_clear_enabled: false
    update_interval: never

touchscreen:
  - platform: ft63x6
    id: touch
    reset_pin:
      aw9523b: aw9523b_hub
      number: 0
    calibration:
      x_min: 0
      x_max: 320
      y_min: 0
      y_max: 240

# LCD backlight - always on
light:
  - platform: monochromatic
    id: lcd_backlight
    name: "LCD Backlight"
    icon: "mdi:television"
    entity_category: config
    output: lcd_backlight_output
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 250ms

# Status LED (virtual) - binary light that reports on/off to HA
# Simulates the WS2812B LED on the real device
  - platform: binary
    name: "Status LED"
    id: status_led
    output: status_led_output
    restore_mode: RESTORE_DEFAULT_ON

# ──────────────────────────────────────────────
# Globals
# ──────────────────────────────────────────────

globals:
  # Current simulated moisture percentages
  - id: sim_moisture_1
    type: int
    restore_value: no
    initial_value: '50'
  - id: sim_moisture_2
    type: int
    restore_value: no
    initial_value: '50'
  - id: sim_moisture_3
    type: int
    restore_value: no
    initial_value: '50'

  # Sweep targets
  - id: sweep_target_1
    type: int
    restore_value: no
    initial_value: '80'
  - id: sweep_target_2
    type: int
    restore_value: no
    initial_value: '80'
  - id: sweep_target_3
    type: int
    restore_value: no
    initial_value: '80'

  # Sweep start values (captured when sweep begins)
  - id: sweep_start_1
    type: int
    restore_value: no
    initial_value: '0'
  - id: sweep_start_2
    type: int
    restore_value: no
    initial_value: '0'
  - id: sweep_start_3
    type: int
    restore_value: no
    initial_value: '0'

  # Sweep duration in seconds (shared for all 3)
  - id: sweep_duration_sec
    type: int
    restore_value: no
    initial_value: '60'

  # Sweep direction: true = UP (toward target), false = DOWN (toward 0)
  - id: sweep_direction_up
    type: bool
    restore_value: no
    initial_value: 'true'

  # Sweep control
  - id: sweep_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sweep_start_time
    type: unsigned long
    restore_value: no
    initial_value: '0'

  # Rain simulation state
  - id: rain_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: soil_type
    type: int
    restore_value: no
    initial_value: '1'
  - id: precip_rate
    type: int
    restore_value: no
    initial_value: '1'
  - id: time_factor
    type: float
    restore_value: no
    initial_value: '1.0'
  - id: s2_pending
    type: float
    restore_value: no
    initial_value: '0.0'
  - id: s1_pending
    type: float
    restore_value: no
    initial_value: '0.0'
  - id: sim_moisture_f1
    type: float
    restore_value: no
    initial_value: '50.0'
  - id: sim_moisture_f2
    type: float
    restore_value: no
    initial_value: '50.0'
  - id: sim_moisture_f3
    type: float
    restore_value: no
    initial_value: '50.0'

  # Status LED virtual state
  - id: status_led_state
    type: bool
    restore_value: no
    initial_value: 'true'

  # Sleep/wake state
  - id: device_awake
    type: bool
    restore_value: no
    initial_value: 'true'
  - id: wifi_sta_connected
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sleep_disabled
    type: bool
    restore_value: true
    initial_value: 'true'
  - id: sleep_duration_minutes
    type: int
    restore_value: true
    initial_value: '60'
  - id: sleep_sequence_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sleep_sequence_start_time
    type: unsigned long
    restore_value: no
    initial_value: '0'

# ──────────────────────────────────────────────
# Sensors (matching real device entity names)
# ──────────────────────────────────────────────

sensor:
  - platform: template
    name: "Moisture 1 Percentage"
    id: moisture_1_percent
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "humidity"
    state_class: "measurement"
    lambda: |-
      return id(sim_moisture_1);
    update_interval: 5s

  - platform: template
    name: "Moisture 2 Percentage"
    id: moisture_2_percent
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "humidity"
    state_class: "measurement"
    lambda: |-
      return id(sim_moisture_2);
    update_interval: 5s

  - platform: template
    name: "Moisture 3 Percentage"
    id: moisture_3_percent
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "humidity"
    state_class: "measurement"
    lambda: |-
      return id(sim_moisture_3);
    update_interval: 5s

  - platform: template
    name: "Battery Voltage"
    id: battery_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    device_class: "voltage"
    state_class: "measurement"
    lambda: 'return 3.8;'
    update_interval: 30s

  - platform: template
    name: "Solar Voltage"
    id: solar_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    device_class: "voltage"
    state_class: "measurement"
    lambda: 'return 5.0;'
    update_interval: 30s

  - platform: template
    name: "Battery Percentage"
    id: battery_percentage
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "battery"
    state_class: "measurement"
    lambda: 'return 67.0;'
    update_interval: 30s

  - platform: template
    name: "Temperature"
    id: aht20_temperature
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    device_class: "temperature"
    state_class: "measurement"
    lambda: 'return 22.0;'
    update_interval: 60s

  - platform: template
    name: "Humidity"
    id: aht20_humidity
    unit_of_measurement: "%"
    accuracy_decimals: 1
    device_class: "humidity"
    state_class: "measurement"
    lambda: 'return 45.0;'
    update_interval: 60s

  - platform: wifi_signal
    name: "WiFi Signal Strength"
    id: wifi_signal_strength
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    id: uptime_sensor

  - platform: template
    name: "Sleep Duration"
    id: current_sleep_duration_sensor
    lambda: 'return id(sleep_duration_minutes);'
    unit_of_measurement: "min"
    accuracy_decimals: 0
    update_interval: 30s

  - platform: template
    name: "Time Awake"
    id: time_awake_sensor
    lambda: |-
      if (!id(device_awake)) return 0.0f;
      unsigned long awake_ms = millis();
      return awake_ms / (60.0f * 1000.0f);
    unit_of_measurement: "min"
    accuracy_decimals: 0
    update_interval: 30s

  # Raw voltage sensors (simulated fixed values)
  - platform: template
    name: "Moisture 1 Raw Voltage"
    id: moisture_1
    unit_of_measurement: "V"
    accuracy_decimals: 3
    device_class: "voltage"
    state_class: "measurement"
    lambda: |-
      // Map percentage back to voltage range (dry=1.979V, wet=1.388V)
      float pct = id(sim_moisture_1) / 100.0f;
      return 1.979f - pct * (1.979f - 1.388f);
    update_interval: 5s

  - platform: template
    name: "Moisture 2 Raw Voltage"
    id: moisture_2
    unit_of_measurement: "V"
    accuracy_decimals: 3
    device_class: "voltage"
    state_class: "measurement"
    lambda: |-
      float pct = id(sim_moisture_2) / 100.0f;
      return 1.979f - pct * (1.979f - 1.388f);
    update_interval: 5s

  - platform: template
    name: "Moisture 3 Raw Voltage"
    id: moisture_3
    unit_of_measurement: "V"
    accuracy_decimals: 3
    device_class: "voltage"
    state_class: "measurement"
    lambda: |-
      float pct = id(sim_moisture_3) / 100.0f;
      return 2.046f - pct * (2.046f - 1.391f);
    update_interval: 5s

# ──────────────────────────────────────────────
# Binary Sensors (matching real device)
# ──────────────────────────────────────────────

binary_sensor:
  - platform: template
    name: "Solar Charging"
    id: solar_charging
    lambda: 'return true;'
    device_class: "battery_charging"

  - platform: template
    name: "Home Assistant Connected"
    id: ha_connected
    lambda: 'return id(api_server).is_connected();'
    device_class: "connectivity"

  - platform: template
    name: "WiFi Connected"
    id: wifi_sta_connected_bin
    device_class: "connectivity"
    lambda: 'return id(wifi_sta_connected);'

  - platform: template
    name: "Device Awake"
    id: device_awake_bin
    lambda: 'return id(device_awake);'

# ──────────────────────────────────────────────
# Controls (matching real device)
# ──────────────────────────────────────────────

number:
  - platform: template
    name: "Sleep Duration"
    id: sleep_duration_input
    icon: "mdi:sleep"
    min_value: 1
    max_value: 1440
    step: 1
    mode: box
    unit_of_measurement: "min"
    entity_category: "config"
    optimistic: true
    restore_value: true
    initial_value: 60
    set_action:
      - lambda: |-
          if (x >= 1 && x <= 1440) {
            id(sleep_duration_minutes) = (int)x;
          }

  - platform: template
    name: "Max Awake Duration"
    id: max_awake_input
    icon: "mdi:timer-outline"
    min_value: 10
    max_value: 1440
    step: 5
    mode: box
    unit_of_measurement: "min"
    entity_category: "config"
    optimistic: true
    restore_value: true
    initial_value: 120

  - platform: template
    name: "Min Awake Duration"
    id: min_awake_input
    icon: "mdi:timer-sand"
    min_value: 0
    max_value: 15
    step: 1
    mode: box
    unit_of_measurement: "min"
    entity_category: "config"
    optimistic: true
    restore_value: true
    initial_value: 1

switch:
  - platform: template
    name: "Disable Sleep"
    id: sleep_disable_switch
    icon: "mdi:sleep-off"
    entity_category: "config"
    lambda: 'return id(sleep_disabled);'
    turn_on_action:
      - lambda: 'id(sleep_disabled) = true;'
    turn_off_action:
      - lambda: 'id(sleep_disabled) = false;'

button:
  - platform: template
    name: "Sleep Now"
    id: sleep_now_button
    icon: "mdi:power-sleep"
    on_press:
      - lambda: |-
          // Simulate going to sleep
          id(device_awake) = false;
          id(sleep_sequence_active) = true;
          id(sleep_sequence_start_time) = millis();
      - light.turn_off:
          id: status_led

  # Calibration buttons (no-ops in simulator, present for entity parity)
  - platform: template
    name: "Factory Reset Calibration"
    id: factory_reset_calibration_button
    icon: "mdi:factory"
    on_press:
      - logger.log: "SIM: Factory reset calibration (no-op)"

  - platform: template
    name: "Calibrate Moisture 1 Dry"
    id: calibrate_moisture_1_dry_button
    icon: "mdi:water-minus"
    on_press:
      - logger.log: "SIM: Calibrate M1 dry (no-op)"

  - platform: template
    name: "Calibrate Moisture 1 Wet"
    id: calibrate_moisture_1_wet_button
    icon: "mdi:water-plus"
    on_press:
      - logger.log: "SIM: Calibrate M1 wet (no-op)"

  - platform: template
    name: "Calibrate Moisture 2 Dry"
    id: calibrate_moisture_2_dry_button
    icon: "mdi:water-minus"
    on_press:
      - logger.log: "SIM: Calibrate M2 dry (no-op)"

  - platform: template
    name: "Calibrate Moisture 2 Wet"
    id: calibrate_moisture_2_wet_button
    icon: "mdi:water-plus"
    on_press:
      - logger.log: "SIM: Calibrate M2 wet (no-op)"

  - platform: template
    name: "Calibrate Moisture 3 Dry"
    id: calibrate_moisture_3_dry_button
    icon: "mdi:water-minus"
    on_press:
      - logger.log: "SIM: Calibrate M3 dry (no-op)"

  - platform: template
    name: "Calibrate Moisture 3 Wet"
    id: calibrate_moisture_3_wet_button
    icon: "mdi:water-plus"
    on_press:
      - logger.log: "SIM: Calibrate M3 wet (no-op)"

# ──────────────────────────────────────────────
# Sweep tick + Sleep wake-up timer
# ──────────────────────────────────────────────

interval:
  # Sweep interpolation tick
  - interval: 2s
    then:
      - lambda: |-
          // --- Sweep logic ---
          if (id(sweep_active)) {
            unsigned long now = millis();
            float elapsed_s = (float)(now - id(sweep_start_time)) / 1000.0f;
            float duration = (float)id(sweep_duration_sec);
            float t = elapsed_s / duration;
            if (t > 1.0f) t = 1.0f;

            id(sim_moisture_1) = id(sweep_start_1) +
              (int)((id(sweep_target_1) - id(sweep_start_1)) * t);
            id(sim_moisture_2) = id(sweep_start_2) +
              (int)((id(sweep_target_2) - id(sweep_start_2)) * t);
            id(sim_moisture_3) = id(sweep_start_3) +
              (int)((id(sweep_target_3) - id(sweep_start_3)) * t);

            // Update LVGL bars
            lv_bar_set_value(id(bar_sweep_1), id(sim_moisture_1), LV_ANIM_ON);
            lv_bar_set_value(id(bar_sweep_2), id(sim_moisture_2), LV_ANIM_ON);
            lv_bar_set_value(id(bar_sweep_3), id(sim_moisture_3), LV_ANIM_ON);

            // Update value labels
            char buf[8];
            snprintf(buf, sizeof(buf), "%d%%", id(sim_moisture_1));
            lv_label_set_text(id(lbl_sweep_val_1), buf);
            snprintf(buf, sizeof(buf), "%d%%", id(sim_moisture_2));
            lv_label_set_text(id(lbl_sweep_val_2), buf);
            snprintf(buf, sizeof(buf), "%d%%", id(sim_moisture_3));
            lv_label_set_text(id(lbl_sweep_val_3), buf);

            // Update time remaining
            int remaining = (int)(duration - elapsed_s);
            if (remaining < 0) remaining = 0;
            char tbuf[16];
            snprintf(tbuf, sizeof(tbuf), "%d:%02d left", remaining / 60, remaining % 60);
            lv_label_set_text(id(lbl_sweep_time), tbuf);

            // Force publish sensor updates
            id(moisture_1_percent).publish_state(id(sim_moisture_1));
            id(moisture_2_percent).publish_state(id(sim_moisture_2));
            id(moisture_3_percent).publish_state(id(sim_moisture_3));

            if (t >= 1.0f) {
              id(sweep_active) = false;
              lv_label_set_text(id(lbl_sweep_time), "DONE!");
            }
          }

          // --- Rain percolation simulation ---
          // Soil params: {infiltration, percolation, retention, drain}
          static const float soil_params[4][4] = {
            {8.0f, 6.0f, 20.0f, 1.5f},  // 0: Sand
            {4.0f, 2.5f, 55.0f, 0.5f},  // 1: Loam
            {1.5f, 0.8f, 75.0f, 0.2f},  // 2: Clay
            {3.0f, 1.5f, 65.0f, 0.3f}   // 3: Silt
          };
          static const float precip_mult[4] = {0.3f, 1.0f, 2.0f, 4.0f};

          int st = id(soil_type);
          if (st < 0) st = 0; if (st > 3) st = 3;
          float infiltration = soil_params[st][0];
          float percolation  = soil_params[st][1];
          float retention    = soil_params[st][2];
          float drain_rate   = soil_params[st][3];

          int pr = id(precip_rate);
          if (pr < 0) pr = 0; if (pr > 3) pr = 3;
          float pmult = precip_mult[pr];
          float tf = id(time_factor);
          if (tf < 0.1f) tf = 0.1f;

          float &s3 = id(sim_moisture_f3);  // shallow
          float &s2 = id(sim_moisture_f2);  // mid
          float &s1 = id(sim_moisture_f1);  // deep

          if (id(rain_active)) {
            float effective_rain = infiltration * pmult * tf;

            // S3 (shallow) - receives rain directly
            s3 += effective_rain;
            if (s3 > retention) {
              float excess = (s3 - retention) * percolation / 100.0f * tf;
              s3 -= excess;
              id(s2_pending) += excess;
            }

            // S2 (mid) - receives percolation from S3
            float s2_intake = id(s2_pending) * (percolation / infiltration) * tf;
            s2 += s2_intake;
            id(s2_pending) -= s2_intake;
            if (id(s2_pending) < 0.01f) id(s2_pending) = 0.0f;
            if (s2 > retention) {
              float excess = (s2 - retention) * percolation / 100.0f * tf;
              s2 -= excess;
              id(s1_pending) += excess;
            }

            // S1 (deep) - receives percolation from S2
            float s1_intake = id(s1_pending) * (percolation / infiltration) * tf;
            s1 += s1_intake;
            id(s1_pending) -= s1_intake;
            if (id(s1_pending) < 0.01f) id(s1_pending) = 0.0f;
          } else {
            // Auto-dry: evaporation when not raining
            // Also drain any pending moisture
            float s2_intake = id(s2_pending) * (percolation / infiltration) * tf;
            s2 += s2_intake;
            id(s2_pending) -= s2_intake;
            if (id(s2_pending) < 0.01f) id(s2_pending) = 0.0f;

            float s1_intake = id(s1_pending) * (percolation / infiltration) * tf;
            s1 += s1_intake;
            id(s1_pending) -= s1_intake;
            if (id(s1_pending) < 0.01f) id(s1_pending) = 0.0f;

            s3 -= drain_rate * 1.0f * tf;   // shallow dries fastest
            s2 -= drain_rate * 0.6f * tf;   // mid dries slower
            s1 -= drain_rate * 0.3f * tf;   // deep dries slowest
          }

          // Clamp 0-100
          if (s3 < 0.0f) s3 = 0.0f; if (s3 > 100.0f) s3 = 100.0f;
          if (s2 < 0.0f) s2 = 0.0f; if (s2 > 100.0f) s2 = 100.0f;
          if (s1 < 0.0f) s1 = 0.0f; if (s1 > 100.0f) s1 = 100.0f;

          // Copy to int globals and publish
          id(sim_moisture_3) = (int)roundf(s3);
          id(sim_moisture_2) = (int)roundf(s2);
          id(sim_moisture_1) = (int)roundf(s1);

          // Update rain page bars if visible
          lv_bar_set_value(id(bar_rain_3), id(sim_moisture_3), LV_ANIM_ON);
          lv_bar_set_value(id(bar_rain_2), id(sim_moisture_2), LV_ANIM_ON);
          lv_bar_set_value(id(bar_rain_1), id(sim_moisture_1), LV_ANIM_ON);
          {
            char rb[8];
            snprintf(rb, sizeof(rb), "%d%%", id(sim_moisture_3));
            lv_label_set_text(id(lbl_rain_val_3), rb);
            snprintf(rb, sizeof(rb), "%d%%", id(sim_moisture_2));
            lv_label_set_text(id(lbl_rain_val_2), rb);
            snprintf(rb, sizeof(rb), "%d%%", id(sim_moisture_1));
            lv_label_set_text(id(lbl_rain_val_1), rb);
          }

          // Also update main page slider labels to reflect sim values
          {
            char mb[8];
            snprintf(mb, sizeof(mb), "%d%%", id(sim_moisture_1));
            lv_label_set_text(id(lbl_m1_val), mb);
            snprintf(mb, sizeof(mb), "%d%%", id(sim_moisture_2));
            lv_label_set_text(id(lbl_m2_val), mb);
            snprintf(mb, sizeof(mb), "%d%%", id(sim_moisture_3));
            lv_label_set_text(id(lbl_m3_val), mb);
          }

          // Publish to HA
          id(moisture_1_percent).publish_state(id(sim_moisture_1));
          id(moisture_2_percent).publish_state(id(sim_moisture_2));
          id(moisture_3_percent).publish_state(id(sim_moisture_3));

          // --- Sleep wake-up timer ---
          if (id(sleep_sequence_active)) {
            unsigned long elapsed_ms = millis() - id(sleep_sequence_start_time);
            unsigned long sleep_ms = (unsigned long)id(sleep_duration_minutes) * 60UL * 1000UL;
            if (elapsed_ms >= sleep_ms) {
              id(sleep_sequence_active) = false;
              id(device_awake) = true;
              id(status_led_state) = true;
              // Turn virtual LED back on
              auto call = id(status_led).turn_on();
              call.perform();
              // Update UI labels
              lv_label_set_text(id(lbl_awake_status), "AWAKE");
              lv_obj_set_style_text_color(id(lbl_awake_status), lv_color_hex(0x00E676), 0);
              lv_label_set_text(id(lbl_sleep_btn), "SLEEP");
              lv_label_set_text(id(lbl_led_status), "LED: ON");
              lv_obj_set_style_text_color(id(lbl_led_status), lv_color_hex(0x00E676), 0);
            }
          }

# ──────────────────────────────────────────────
# LVGL UI
# ──────────────────────────────────────────────

lvgl:
  displays:
    - m5cores3_lcd
  touchscreens:
    - touchscreen_id: touch
  color_depth: 16
  buffer_size: 10%
  default_font: montserrat_14
  disp_bg_color: 0x0D0D0D

  style_definitions:
    - id: style_btn
      bg_color: 0x00E676
      radius: 8
      text_color: 0x0D0D0D
      pad_all: 6
    - id: style_btn_outline
      bg_color: 0x1A1A1A
      radius: 8
      border_width: 2
      border_color: 0x00E676
      text_color: 0x00E676
      pad_all: 6
    - id: style_btn_red
      bg_color: 0xFF3D00
      radius: 8
      text_color: 0xFFFFFF
      pad_all: 6

  pages:
    # ──────── PAGE: SPLASH ────────
    - id: page_splash
      bg_color: 0x0D0D0D
      widgets:
        - image:
            src: gophr_logo
            align: CENTER
            y: -20
        - label:
            text: "GOPHR"
            text_font: montserrat_28
            text_color: 0x00E676
            align: CENTER
            y: 60
        - label:
            text: "Moisture Probe Simulator"
            text_font: montserrat_14
            text_color: 0x888888
            align: CENTER
            y: 85
        - label:
            id: lbl_splash_status
            text: "Starting..."
            text_font: montserrat_12
            text_color: 0x555555
            align: CENTER
            y: 110

    # ──────── PAGE: MAIN ────────
    - id: page_main
      bg_color: 0x0D0D0D
      widgets:
        # Title
        - label:
            text: "GOPHR SIM"
            text_font: montserrat_14
            text_color: 0x888888
            x: 10
            y: 6

        # Awake status indicator
        - label:
            id: lbl_awake_status
            text: "AWAKE"
            text_font: montserrat_12
            text_color: 0x00E676
            align: TOP_RIGHT
            x: -10
            y: 2

        # LED status indicator
        - label:
            id: lbl_led_status
            text: "LED: ON"
            text_font: montserrat_12
            text_color: 0x00E676
            align: TOP_RIGHT
            x: -10
            y: 16

        # --- Sensor 1: SHALLOW ---
        - label:
            text: "S1 SHALLOW"
            text_font: montserrat_12
            text_color: 0x888888
            x: 10
            y: 30

        - slider:
            id: slider_m1
            x: 10
            y: 48
            width: 250
            height: 18
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF
            knob:
              bg_color: 0xFFFFFF
              radius: 9
              width: 18
              height: 18
            on_value:
              then:
                - lambda: 'id(sim_moisture_1) = (int)x;'
                - lvgl.label.update:
                    id: lbl_m1_val
                    text:
                      format: "%d%%"
                      args: ['(int)x']

        - label:
            id: lbl_m1_val
            text: "50%"
            text_font: montserrat_14
            text_color: 0xFFFFFF
            x: 270
            y: 48

        # --- Sensor 2: MID ---
        - label:
            text: "S2 MID"
            text_font: montserrat_12
            text_color: 0x888888
            x: 10
            y: 76

        - slider:
            id: slider_m2
            x: 10
            y: 94
            width: 250
            height: 18
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5
            knob:
              bg_color: 0xFFFFFF
              radius: 9
              width: 18
              height: 18
            on_value:
              then:
                - lambda: 'id(sim_moisture_2) = (int)x;'
                - lvgl.label.update:
                    id: lbl_m2_val
                    text:
                      format: "%d%%"
                      args: ['(int)x']

        - label:
            id: lbl_m2_val
            text: "50%"
            text_font: montserrat_14
            text_color: 0xFFFFFF
            x: 270
            y: 94

        # --- Sensor 3: DEEP ---
        - label:
            text: "S3 DEEP"
            text_font: montserrat_12
            text_color: 0x888888
            x: 10
            y: 122

        - slider:
            id: slider_m3
            x: 10
            y: 140
            width: 250
            height: 18
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00
            knob:
              bg_color: 0xFFFFFF
              radius: 9
              width: 18
              height: 18
            on_value:
              then:
                - lambda: 'id(sim_moisture_3) = (int)x;'
                - lvgl.label.update:
                    id: lbl_m3_val
                    text:
                      format: "%d%%"
                      args: ['(int)x']

        - label:
            id: lbl_m3_val
            text: "50%"
            text_font: montserrat_14
            text_color: 0xFFFFFF
            x: 270
            y: 140

        # --- Bottom buttons ---
        - button:
            id: btn_send
            x: 10
            y: 180
            width: 80
            height: 45
            styles: style_btn
            widgets:
              - label:
                  text: "SEND"
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    id(moisture_1_percent).publish_state(id(sim_moisture_1));
                    id(moisture_2_percent).publish_state(id(sim_moisture_2));
                    id(moisture_3_percent).publish_state(id(sim_moisture_3));

        - button:
            id: btn_goto_sim
            x: 100
            y: 180
            width: 100
            height: 45
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SIM >"
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_LEFT
                    time: 300ms

        - button:
            id: btn_sleep_toggle
            x: 210
            y: 180
            width: 100
            height: 45
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_sleep_btn
                  text: "SLEEP"
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(device_awake)) {
                      // Go to sleep
                      id(device_awake) = false;
                      id(sleep_sequence_active) = true;
                      id(sleep_sequence_start_time) = millis();
                      lv_label_set_text(id(lbl_awake_status), "SLEEPING");
                      lv_obj_set_style_text_color(id(lbl_awake_status), lv_color_hex(0xFF3D00), 0);
                      lv_label_set_text(id(lbl_sleep_btn), "WAKE");
                    } else {
                      // Wake up
                      id(device_awake) = true;
                      id(sleep_sequence_active) = false;
                      lv_label_set_text(id(lbl_awake_status), "AWAKE");
                      lv_obj_set_style_text_color(id(lbl_awake_status), lv_color_hex(0x00E676), 0);
                      lv_label_set_text(id(lbl_sleep_btn), "SLEEP");
                    }
                - if:
                    condition:
                      lambda: 'return !id(device_awake);'
                    then:
                      - light.turn_off:
                          id: status_led
                      - lvgl.label.update:
                          id: lbl_led_status
                          text: "LED: OFF"
                      - lambda: |-
                          lv_obj_set_style_text_color(id(lbl_led_status), lv_color_hex(0xFF3D00), 0);
                    else:
                      - light.turn_on:
                          id: status_led
                      - lvgl.label.update:
                          id: lbl_led_status
                          text: "LED: ON"
                      - lambda: |-
                          lv_obj_set_style_text_color(id(lbl_led_status), lv_color_hex(0x00E676), 0);

    # ──────── PAGE: SWEEP CONFIG ────────
    - id: page_sweep_cfg
      bg_color: 0x0D0D0D
      widgets:
        - label:
            text: "SWEEP CONFIG"
            text_font: montserrat_14
            text_color: 0x888888
            align: TOP_MID
            y: 4

        # --- S1 Target ---
        - label:
            text: "S1"
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 28

        - slider:
            id: slider_sweep_t1
            x: 25
            y: 28
            width: 200
            height: 14
            min_value: 0
            max_value: 100
            value: 80
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF
            knob:
              bg_color: 0xFFFFFF
              radius: 7
            on_value:
              then:
                - lambda: 'id(sweep_target_1) = (int)x;'
                - lvgl.label.update:
                    id: lbl_st1
                    text:
                      format: "%d%%"
                      args: ['(int)x']

        - label:
            id: lbl_st1
            text: "80%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 232
            y: 28

        # --- S2 Target ---
        - label:
            text: "S2"
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 54

        - slider:
            id: slider_sweep_t2
            x: 25
            y: 54
            width: 200
            height: 14
            min_value: 0
            max_value: 100
            value: 80
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5
            knob:
              bg_color: 0xFFFFFF
              radius: 7
            on_value:
              then:
                - lambda: 'id(sweep_target_2) = (int)x;'
                - lvgl.label.update:
                    id: lbl_st2
                    text:
                      format: "%d%%"
                      args: ['(int)x']

        - label:
            id: lbl_st2
            text: "80%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 232
            y: 54

        # --- S3 Target ---
        - label:
            text: "S3"
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 80

        - slider:
            id: slider_sweep_t3
            x: 25
            y: 80
            width: 200
            height: 14
            min_value: 0
            max_value: 100
            value: 80
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00
            knob:
              bg_color: 0xFFFFFF
              radius: 7
            on_value:
              then:
                - lambda: 'id(sweep_target_3) = (int)x;'
                - lvgl.label.update:
                    id: lbl_st3
                    text:
                      format: "%d%%"
                      args: ['(int)x']

        - label:
            id: lbl_st3
            text: "80%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 232
            y: 80

        # --- Duration ---
        - label:
            text: "Duration:"
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 108

        - label:
            id: lbl_duration_val
            text: "1m"
            text_font: montserrat_14
            text_color: 0x00E676
            x: 75
            y: 106

        - buttonmatrix:
            id: btnm_duration
            x: 5
            y: 124
            width: 310
            height: 34
            rows:
              - buttons:
                  - id: btn_d_30s
                    text: "30s"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 30;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "30s"
                  - id: btn_d_1m
                    text: "1m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 60;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "1m"
                  - id: btn_d_5m
                    text: "5m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 300;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "5m"
                  - id: btn_d_15m
                    text: "15m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 900;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "15m"
                  - id: btn_d_30m
                    text: "30m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 1800;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "30m"
                  - id: btn_d_1h
                    text: "1h"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 3600;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "1h"

        # --- Direction ---
        - label:
            text: "Direction:"
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 165

        - button:
            id: btn_dir_up
            x: 85
            y: 162
            width: 60
            height: 28
            styles: style_btn
            widgets:
              - label:
                  text: "UP"
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: 'id(sweep_direction_up) = true;'

        - button:
            id: btn_dir_down
            x: 155
            y: 162
            width: 70
            height: 28
            styles: style_btn_outline
            widgets:
              - label:
                  text: "DOWN"
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(sweep_direction_up) = false;'

        # --- Bottom nav ---
        - button:
            x: 5
            y: 200
            width: 90
            height: 35
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_RIGHT
                    time: 300ms

        - button:
            id: btn_start_sweep
            x: 220
            y: 200
            width: 95
            height: 35
            styles: style_btn
            widgets:
              - label:
                  text: "START >"
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    // Capture start values
                    if (id(sweep_direction_up)) {
                      // UP: sweep from current slider values toward targets
                      id(sweep_start_1) = id(sim_moisture_1);
                      id(sweep_start_2) = id(sim_moisture_2);
                      id(sweep_start_3) = id(sim_moisture_3);
                    } else {
                      // DOWN: sweep from targets toward 0
                      id(sweep_start_1) = id(sweep_target_1);
                      id(sweep_start_2) = id(sweep_target_2);
                      id(sweep_start_3) = id(sweep_target_3);
                      id(sweep_target_1) = 0;
                      id(sweep_target_2) = 0;
                      id(sweep_target_3) = 0;
                      // Set current moisture to the start values
                      id(sim_moisture_1) = id(sweep_start_1);
                      id(sim_moisture_2) = id(sweep_start_2);
                      id(sim_moisture_3) = id(sweep_start_3);
                    }
                    id(sweep_start_time) = millis();
                    id(sweep_active) = true;

                    // Initialize running page bars
                    lv_bar_set_value(id(bar_sweep_1), id(sim_moisture_1), LV_ANIM_OFF);
                    lv_bar_set_value(id(bar_sweep_2), id(sim_moisture_2), LV_ANIM_OFF);
                    lv_bar_set_value(id(bar_sweep_3), id(sim_moisture_3), LV_ANIM_OFF);
                - lvgl.page.show:
                    id: page_sweep_run
                    animation: MOVE_LEFT
                    time: 300ms

    # ──────── PAGE: SWEEP RUNNING ────────
    - id: page_sweep_run
      bg_color: 0x0D0D0D
      widgets:
        - label:
            text: "SWEEPING..."
            text_font: montserrat_14
            text_color: 0x00E676
            x: 10
            y: 8

        - label:
            id: lbl_sweep_time
            text: "0:00 left"
            text_font: montserrat_14
            text_color: 0xFFFFFF
            align: TOP_RIGHT
            x: -10
            y: 8

        # --- S1 bar ---
        - label:
            text: "S1"
            text_font: montserrat_12
            text_color: 0x888888
            x: 10
            y: 40

        - bar:
            id: bar_sweep_1
            x: 30
            y: 40
            width: 230
            height: 16
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF

        - label:
            id: lbl_sweep_val_1
            text: "0%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 270
            y: 40

        # --- S2 bar ---
        - label:
            text: "S2"
            text_font: montserrat_12
            text_color: 0x888888
            x: 10
            y: 70

        - bar:
            id: bar_sweep_2
            x: 30
            y: 70
            width: 230
            height: 16
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5

        - label:
            id: lbl_sweep_val_2
            text: "0%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 270
            y: 70

        # --- S3 bar ---
        - label:
            text: "S3"
            text_font: montserrat_12
            text_color: 0x888888
            x: 10
            y: 100

        - bar:
            id: bar_sweep_3
            x: 30
            y: 100
            width: 230
            height: 16
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00

        - label:
            id: lbl_sweep_val_3
            text: "0%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 270
            y: 100

        # --- Cancel button ---
        - button:
            id: btn_cancel_sweep
            align: BOTTOM_MID
            y: -15
            width: 140
            height: 45
            styles: style_btn_red
            widgets:
              - label:
                  text: "CANCEL"
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - lambda: 'id(sweep_active) = false;'
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_RIGHT
                    time: 300ms

    # ──────── PAGE: SIM MODE SELECT ────────
    - id: page_sim_select
      bg_color: 0x0D0D0D
      widgets:
        - label:
            text: "SIMULATION MODE"
            text_font: montserrat_14
            text_color: 0x888888
            align: TOP_MID
            y: 8

        - button:
            id: btn_mode_sweep
            x: 30
            y: 40
            width: 260
            height: 55
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SWEEP MODE"
                  text_font: montserrat_14
                  align: CENTER
                  y: -8
                  text_color: 0x00E676
              - label:
                  text: "Linear ramp to targets"
                  text_font: montserrat_12
                  align: CENTER
                  y: 10
                  text_color: 0x888888
            on_click:
              then:
                - lvgl.page.show:
                    id: page_sweep_cfg
                    animation: MOVE_LEFT
                    time: 300ms

        - button:
            id: btn_mode_rain
            x: 30
            y: 110
            width: 260
            height: 55
            styles: style_btn
            widgets:
              - label:
                  text: "RAIN MODE"
                  text_font: montserrat_14
                  align: CENTER
                  y: -8
                  text_color: 0x0D0D0D
              - label:
                  text: "Soil percolation sim"
                  text_font: montserrat_12
                  align: CENTER
                  y: 10
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lvgl.page.show:
                    id: page_rain
                    animation: MOVE_LEFT
                    time: 300ms

        - button:
            x: 110
            y: 190
            width: 100
            height: 38
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_main
                    animation: MOVE_RIGHT
                    time: 300ms

    # ──────── PAGE: RAIN SIMULATION ────────
    - id: page_rain
      bg_color: 0x0D0D0D
      widgets:
        - label:
            text: "RAIN SIM"
            text_font: montserrat_14
            text_color: 0x888888
            x: 10
            y: 4

        # Rain status indicator
        - label:
            id: lbl_rain_status
            text: "STOPPED"
            text_font: montserrat_12
            text_color: 0xFF3D00
            align: TOP_RIGHT
            x: -10
            y: 4

        # --- Soil type selector ---
        - label:
            text: "Soil:"
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 24

        - buttonmatrix:
            id: btnm_soil
            x: 45
            y: 20
            width: 270
            height: 28
            rows:
              - buttons:
                  - id: btn_sand
                    text: "SAND"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 0;'
                  - id: btn_loam
                    text: "LOAM"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 1;'
                  - id: btn_clay
                    text: "CLAY"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 2;'
                  - id: btn_silt
                    text: "SILT"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 3;'

        # --- Precipitation rate selector ---
        - label:
            text: "Rain:"
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 56

        - buttonmatrix:
            id: btnm_precip
            x: 45
            y: 52
            width: 270
            height: 28
            rows:
              - buttons:
                  - id: btn_drizzle
                    text: "DRIZ"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 0;'
                  - id: btn_rain_rate
                    text: "RAIN"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 1;'
                  - id: btn_heavy
                    text: "HEVY"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 2;'
                  - id: btn_pour
                    text: "POUR"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 3;'

        # --- Time factor: 1 week = X hours ---
        - label:
            text: "1 wk ="
            text_font: montserrat_12
            text_color: 0x888888
            x: 5
            y: 88

        - slider:
            id: slider_time_factor
            x: 60
            y: 88
            width: 190
            height: 14
            min_value: 1
            max_value: 168
            value: 1
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00E676
            knob:
              bg_color: 0xFFFFFF
              radius: 7
            on_value:
              then:
                - lambda: |-
                    // Time factor: how many real hours = 1 simulated week
                    // 1 week = 168 hours real time at 1x
                    // If slider=1, 1wk=1hr (168x speed)
                    // If slider=168, 1wk=168hr (1x realtime)
                    id(time_factor) = 168.0f / x;
                - lvgl.label.update:
                    id: lbl_time_factor
                    text:
                      format: "%dhr"
                      args: ['(int)x']

        - label:
            id: lbl_time_factor
            text: "1hr"
            text_font: montserrat_12
            text_color: 0x00E676
            x: 260
            y: 88

        # --- Live sensor bars ---
        - label:
            text: "S3 SHALLOW"
            text_font: montserrat_10
            text_color: 0x888888
            x: 5
            y: 112

        - bar:
            id: bar_rain_3
            x: 5
            y: 124
            width: 255
            height: 14
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF

        - label:
            id: lbl_rain_val_3
            text: "50%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 268
            y: 122

        - label:
            text: "S2 MID"
            text_font: montserrat_10
            text_color: 0x888888
            x: 5
            y: 142

        - bar:
            id: bar_rain_2
            x: 5
            y: 154
            width: 255
            height: 14
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5

        - label:
            id: lbl_rain_val_2
            text: "50%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 268
            y: 152

        - label:
            text: "S1 DEEP"
            text_font: montserrat_10
            text_color: 0x888888
            x: 5
            y: 172

        - bar:
            id: bar_rain_1
            x: 5
            y: 184
            width: 255
            height: 14
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00

        - label:
            id: lbl_rain_val_1
            text: "50%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 268
            y: 182

        # --- Bottom buttons ---
        - button:
            x: 5
            y: 205
            width: 70
            height: 30
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(rain_active) = false;'
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_RIGHT
                    time: 300ms

        - button:
            id: btn_start_rain
            x: 85
            y: 205
            width: 110
            height: 30
            styles: style_btn
            widgets:
              - label:
                  text: "START"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    id(rain_active) = true;
                    // Sync float state from current int values
                    id(sim_moisture_f1) = (float)id(sim_moisture_1);
                    id(sim_moisture_f2) = (float)id(sim_moisture_2);
                    id(sim_moisture_f3) = (float)id(sim_moisture_3);
                - lvgl.label.update:
                    id: lbl_rain_status
                    text: "RAINING"
                - lambda: |-
                    lv_obj_set_style_text_color(id(lbl_rain_status), lv_color_hex(0x2979FF), 0);

        - button:
            id: btn_stop_rain
            x: 205
            y: 205
            width: 110
            height: 30
            styles: style_btn_red
            widgets:
              - label:
                  text: "STOP"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - lambda: 'id(rain_active) = false;'
                - lvgl.label.update:
                    id: lbl_rain_status
                    text: "DRYING"
                - lambda: |-
                    lv_obj_set_style_text_color(id(lbl_rain_status), lv_color_hex(0xFFAB00), 0);
