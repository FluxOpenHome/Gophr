# Gophr Simulator - M5Stack Dial (StampS3)
# Simulates the Gophr moisture probe for HA testing
# Entity names match the real gophr.yaml device

substitutions:
  name: "gophr"
  friendly_name: "Gophr"
  software_version: "1.0.0-sim"

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"
  name_add_mac_suffix: true
  project:
    name: "FluxOpenHome.Gophr"
    version: "${software_version}"
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    priority: -100
    then:
      - light.turn_on:
          id: lcd_backlight
          brightness: 100%
      - lvgl.page.show:
          id: page_splash
          animation: NONE
      - delay: 5s
      - lvgl.page.show:
          id: page_main
          animation: FADE_IN
          time: 500ms
      - light.turn_on:
          id: status_led
      - lambda: |-
          id(device_awake) = true;
          id(status_led_state) = true;
      - delay: 500ms
      - lambda: |-
          // Create per-page focus groups for encoder navigation
          lv_group_t *gm = lv_group_create();
          lv_group_t *gs = lv_group_create();
          lv_group_t *gr = lv_group_create();
          lv_group_t *gx = lv_group_create();
          lv_group_t *gn = lv_group_create();

          // page_main (S3 top, S2 mid, S1 bottom)
          lv_group_add_obj(gm, id(slider_m3));
          lv_group_add_obj(gm, id(slider_m2));
          lv_group_add_obj(gm, id(slider_m1));
          lv_group_add_obj(gm, id(btn_send));
          lv_group_add_obj(gm, id(btn_goto_sim));
          lv_group_add_obj(gm, id(btn_sleep_toggle));

          // page_sweep_cfg
          lv_group_add_obj(gs, id(slider_sweep_t1));
          lv_group_add_obj(gs, id(slider_sweep_t2));
          lv_group_add_obj(gs, id(slider_sweep_t3));
          lv_group_add_obj(gs, id(btnm_duration));
          lv_group_add_obj(gs, id(btn_dir_up));
          lv_group_add_obj(gs, id(btn_dir_down));
          lv_group_add_obj(gs, id(btn_start_sweep));
          lv_group_add_obj(gs, id(btn_back_sweep_cfg));

          // page_sweep_run
          lv_group_add_obj(gr, id(btn_cancel_sweep));

          // page_sim_select
          lv_group_add_obj(gx, id(btn_mode_sweep));
          lv_group_add_obj(gx, id(btn_mode_rain));
          lv_group_add_obj(gx, id(btn_back_sim_select));

          // page_rain
          lv_group_add_obj(gn, id(btnm_soil));
          lv_group_add_obj(gn, id(btnm_precip));
          lv_group_add_obj(gn, id(slider_time_factor));
          lv_group_add_obj(gn, id(btn_start_rain));
          lv_group_add_obj(gn, id(btn_stop_rain));
          lv_group_add_obj(gn, id(btn_back_rain));

          // Store group pointers
          id(grp_main) = (void*)gm;
          id(grp_sweep_cfg) = (void*)gs;
          id(grp_sweep_run) = (void*)gr;
          id(grp_sim_select) = (void*)gx;
          id(grp_rain) = (void*)gn;

          // Find encoder indev and assign initial group
          lv_indev_t *enc = nullptr;
          while ((enc = lv_indev_get_next(enc)) != nullptr) {
            if (lv_indev_get_type(enc) == LV_INDEV_TYPE_ENCODER) {
              id(enc_indev) = (void*)enc;
              lv_indev_set_group(enc, gm);
              break;
            }
          }

esp32:
  variant: esp32s3
  framework:
    type: esp-idf

logger:
  level: DEBUG

api:
  id: api_server

ota:
  - platform: esphome

wifi:
  id: wifi_component
  ap:
    ssid: "${name}"
  on_connect:
    - lambda: |-
        id(wifi_sta_connected) = true;
  on_disconnect:
    - lambda: |-
        id(wifi_sta_connected) = false;

captive_portal:

esp32_improv:
  authorizer: none

web_server:
  port: 80

# ──────────────────────────────────────────────
# M5Stack Dial (StampS3) Hardware
# ──────────────────────────────────────────────

i2c:
  - id: internal_i2c
    sda: GPIO11
    scl: GPIO12

spi:
  - id: spi_bus
    clk_pin: GPIO6
    mosi_pin: GPIO5

output:
  - platform: ledc
    pin: GPIO9
    id: lcd_backlight_output
  # Virtual output for the Status LED light entity
  - platform: template
    type: binary
    id: status_led_output
    write_action:
      - lambda: |-
          id(status_led_state) = state;

# NOTE: Copy gophr.png into your ESPHome config directory alongside this YAML
image:
  - id: gophr_logo
    file: "gophr.png"
    resize: 140x80
    type: RGB565
    transparency: alpha_channel

display:
  - platform: ili9xxx
    model: GC9A01A
    cs_pin: GPIO7
    reset_pin: GPIO8
    dc_pin: GPIO4
    id: dial_lcd
    invert_colors: true
    auto_clear_enabled: false
    update_interval: never

touchscreen:
  - platform: ft5x06
    id: touch
    i2c_id: internal_i2c
    address: 0x38

# LCD backlight - always on
light:
  - platform: monochromatic
    id: lcd_backlight
    name: "LCD Backlight"
    icon: "mdi:television"
    entity_category: config
    output: lcd_backlight_output
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 0s

# Status LED (virtual) - binary light that reports on/off to HA
# Simulates the WS2812B LED on the real device
  - platform: binary
    name: "Status LED"
    id: status_led
    output: status_led_output
    restore_mode: RESTORE_DEFAULT_ON

# ──────────────────────────────────────────────
# Globals
# ──────────────────────────────────────────────

globals:
  # Current simulated moisture percentages
  - id: sim_moisture_1
    type: int
    restore_value: no
    initial_value: '50'
  - id: sim_moisture_2
    type: int
    restore_value: no
    initial_value: '50'
  - id: sim_moisture_3
    type: int
    restore_value: no
    initial_value: '50'

  # Sweep targets
  - id: sweep_target_1
    type: int
    restore_value: no
    initial_value: '80'
  - id: sweep_target_2
    type: int
    restore_value: no
    initial_value: '80'
  - id: sweep_target_3
    type: int
    restore_value: no
    initial_value: '80'

  # Sweep start values (captured when sweep begins)
  - id: sweep_start_1
    type: int
    restore_value: no
    initial_value: '0'
  - id: sweep_start_2
    type: int
    restore_value: no
    initial_value: '0'
  - id: sweep_start_3
    type: int
    restore_value: no
    initial_value: '0'

  # Sweep duration in seconds (shared for all 3)
  - id: sweep_duration_sec
    type: int
    restore_value: no
    initial_value: '60'

  # Sweep direction: true = UP (toward target), false = DOWN (toward 0)
  - id: sweep_direction_up
    type: bool
    restore_value: no
    initial_value: 'true'

  # Sweep control
  - id: sweep_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sweep_start_time
    type: unsigned long
    restore_value: no
    initial_value: '0'

  # Rain simulation state
  - id: rain_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: rain_ever_started
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: soil_type
    type: int
    restore_value: no
    initial_value: '1'
  - id: precip_rate
    type: int
    restore_value: no
    initial_value: '1'
  - id: time_factor
    type: float
    restore_value: no
    initial_value: '1.0'
  - id: s2_pending
    type: float
    restore_value: no
    initial_value: '0.0'
  - id: s1_pending
    type: float
    restore_value: no
    initial_value: '0.0'
  - id: sim_moisture_f1
    type: float
    restore_value: no
    initial_value: '50.0'
  - id: sim_moisture_f2
    type: float
    restore_value: no
    initial_value: '50.0'
  - id: sim_moisture_f3
    type: float
    restore_value: no
    initial_value: '50.0'

  # Status LED virtual state
  - id: status_led_state
    type: bool
    restore_value: no
    initial_value: 'true'

  # Sleep/wake state
  - id: device_awake
    type: bool
    restore_value: no
    initial_value: 'true'
  - id: wifi_sta_connected
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sleep_disabled
    type: bool
    restore_value: true
    initial_value: 'true'
  - id: sleep_duration_minutes
    type: int
    restore_value: true
    initial_value: '60'
  # Encoder focus groups (per-page, to avoid multi-page focus bug)
  - id: enc_indev
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_main
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_sweep_cfg
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_sweep_run
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_sim_select
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_rain
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: sleep_sequence_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sleep_sequence_start_time
    type: unsigned long
    restore_value: no
    initial_value: '0'

# ──────────────────────────────────────────────
# Sensors (matching real device entity names)
# ──────────────────────────────────────────────

sensor:
  - platform: template
    name: "Moisture 1 Percentage"
    id: moisture_1_percent
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "humidity"
    state_class: "measurement"
    lambda: |-
      return id(sim_moisture_1);
    update_interval: 5s

  - platform: template
    name: "Moisture 2 Percentage"
    id: moisture_2_percent
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "humidity"
    state_class: "measurement"
    lambda: |-
      return id(sim_moisture_2);
    update_interval: 5s

  - platform: template
    name: "Moisture 3 Percentage"
    id: moisture_3_percent
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "humidity"
    state_class: "measurement"
    lambda: |-
      return id(sim_moisture_3);
    update_interval: 5s

  - platform: template
    name: "Battery Voltage"
    id: battery_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    device_class: "voltage"
    state_class: "measurement"
    lambda: 'return 3.8;'
    update_interval: 30s

  - platform: template
    name: "Solar Voltage"
    id: solar_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    device_class: "voltage"
    state_class: "measurement"
    lambda: 'return 5.0;'
    update_interval: 30s

  - platform: template
    name: "Battery Percentage"
    id: battery_percentage
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: "battery"
    state_class: "measurement"
    lambda: 'return 67.0;'
    update_interval: 30s

  - platform: template
    name: "Temperature"
    id: aht20_temperature
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    device_class: "temperature"
    state_class: "measurement"
    lambda: 'return 22.0;'
    update_interval: 60s

  - platform: template
    name: "Humidity"
    id: aht20_humidity
    unit_of_measurement: "%"
    accuracy_decimals: 1
    device_class: "humidity"
    state_class: "measurement"
    lambda: 'return 45.0;'
    update_interval: 60s

  - platform: wifi_signal
    name: "WiFi Signal Strength"
    id: wifi_signal_strength
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    id: uptime_sensor

  - platform: template
    name: "Sleep Duration"
    id: current_sleep_duration_sensor
    lambda: 'return id(sleep_duration_minutes);'
    unit_of_measurement: "min"
    accuracy_decimals: 0
    update_interval: 30s

  - platform: template
    name: "Time Awake"
    id: time_awake_sensor
    lambda: |-
      if (!id(device_awake)) return 0.0f;
      unsigned long awake_ms = millis();
      return awake_ms / (60.0f * 1000.0f);
    unit_of_measurement: "min"
    accuracy_decimals: 0
    update_interval: 30s

  # Raw voltage sensors (simulated fixed values)
  - platform: template
    name: "Moisture 1 Raw Voltage"
    id: moisture_1
    unit_of_measurement: "V"
    accuracy_decimals: 3
    device_class: "voltage"
    state_class: "measurement"
    lambda: |-
      // Map percentage back to voltage range (dry=1.979V, wet=1.388V)
      float pct = id(sim_moisture_1) / 100.0f;
      return 1.979f - pct * (1.979f - 1.388f);
    update_interval: 5s

  - platform: template
    name: "Moisture 2 Raw Voltage"
    id: moisture_2
    unit_of_measurement: "V"
    accuracy_decimals: 3
    device_class: "voltage"
    state_class: "measurement"
    lambda: |-
      float pct = id(sim_moisture_2) / 100.0f;
      return 1.979f - pct * (1.979f - 1.388f);
    update_interval: 5s

  - platform: template
    name: "Moisture 3 Raw Voltage"
    id: moisture_3
    unit_of_measurement: "V"
    accuracy_decimals: 3
    device_class: "voltage"
    state_class: "measurement"
    lambda: |-
      float pct = id(sim_moisture_3) / 100.0f;
      return 2.046f - pct * (2.046f - 1.391f);
    update_interval: 5s

  # --- Rotary Encoder (M5 Dial) ---
  - platform: rotary_encoder
    id: dial_encoder
    resolution: 1
    pin_a:
      number: GPIO40
      mode:
        input: true
        pullup: true
    pin_b:
      number: GPIO41
      mode:
        input: true
        pullup: true

# ──────────────────────────────────────────────
# Binary Sensors (matching real device)
# ──────────────────────────────────────────────

binary_sensor:
  - platform: template
    name: "Solar Charging"
    id: solar_charging
    lambda: 'return true;'
    device_class: "battery_charging"

  - platform: template
    name: "Home Assistant Connected"
    id: ha_connected
    lambda: 'return id(api_server).is_connected();'
    device_class: "connectivity"

  - platform: template
    name: "WiFi Connected"
    id: wifi_sta_connected_bin
    device_class: "connectivity"
    lambda: 'return id(wifi_sta_connected);'

  - platform: template
    name: "Device Awake"
    id: device_awake_bin
    lambda: 'return id(device_awake);'

  # --- Dial Front Button (M5 Dial) ---
  - platform: gpio
    id: dial_button
    pin:
      number: GPIO42
      mode:
        input: true
        pullup: true
      inverted: true

# ──────────────────────────────────────────────
# Controls (matching real device)
# ──────────────────────────────────────────────

number:
  - platform: template
    name: "Sleep Duration"
    id: sleep_duration_input
    icon: "mdi:sleep"
    min_value: 1
    max_value: 1440
    step: 1
    mode: box
    unit_of_measurement: "min"
    entity_category: "config"
    optimistic: true
    restore_value: true
    initial_value: 60
    set_action:
      - lambda: |-
          if (x >= 1 && x <= 1440) {
            id(sleep_duration_minutes) = (int)x;
          }

  - platform: template
    name: "Max Awake Duration"
    id: max_awake_input
    icon: "mdi:timer-outline"
    min_value: 10
    max_value: 1440
    step: 5
    mode: box
    unit_of_measurement: "min"
    entity_category: "config"
    optimistic: true
    restore_value: true
    initial_value: 120

  - platform: template
    name: "Min Awake Duration"
    id: min_awake_input
    icon: "mdi:timer-sand"
    min_value: 0
    max_value: 15
    step: 1
    mode: box
    unit_of_measurement: "min"
    entity_category: "config"
    optimistic: true
    restore_value: true
    initial_value: 1

switch:
  - platform: template
    name: "Disable Sleep"
    id: sleep_disable_switch
    icon: "mdi:sleep-off"
    entity_category: "config"
    lambda: 'return id(sleep_disabled);'
    turn_on_action:
      - lambda: 'id(sleep_disabled) = true;'
    turn_off_action:
      - lambda: 'id(sleep_disabled) = false;'

button:
  - platform: template
    name: "Sleep Now"
    id: sleep_now_button
    icon: "mdi:power-sleep"
    on_press:
      - lambda: |-
          // Simulate going to sleep
          id(device_awake) = false;
          id(sleep_sequence_active) = true;
          id(sleep_sequence_start_time) = millis();
      - light.turn_off:
          id: status_led

  # Calibration buttons (no-ops in simulator, present for entity parity)
  - platform: template
    name: "Factory Reset Calibration"
    id: factory_reset_calibration_button
    icon: "mdi:factory"
    on_press:
      - logger.log: "SIM: Factory reset calibration (no-op)"

  - platform: template
    name: "Calibrate Moisture 1 Dry"
    id: calibrate_moisture_1_dry_button
    icon: "mdi:water-minus"
    on_press:
      - logger.log: "SIM: Calibrate M1 dry (no-op)"

  - platform: template
    name: "Calibrate Moisture 1 Wet"
    id: calibrate_moisture_1_wet_button
    icon: "mdi:water-plus"
    on_press:
      - logger.log: "SIM: Calibrate M1 wet (no-op)"

  - platform: template
    name: "Calibrate Moisture 2 Dry"
    id: calibrate_moisture_2_dry_button
    icon: "mdi:water-minus"
    on_press:
      - logger.log: "SIM: Calibrate M2 dry (no-op)"

  - platform: template
    name: "Calibrate Moisture 2 Wet"
    id: calibrate_moisture_2_wet_button
    icon: "mdi:water-plus"
    on_press:
      - logger.log: "SIM: Calibrate M2 wet (no-op)"

  - platform: template
    name: "Calibrate Moisture 3 Dry"
    id: calibrate_moisture_3_dry_button
    icon: "mdi:water-minus"
    on_press:
      - logger.log: "SIM: Calibrate M3 dry (no-op)"

  - platform: template
    name: "Calibrate Moisture 3 Wet"
    id: calibrate_moisture_3_wet_button
    icon: "mdi:water-plus"
    on_press:
      - logger.log: "SIM: Calibrate M3 wet (no-op)"

# ──────────────────────────────────────────────
# Sweep tick + Sleep wake-up timer
# ──────────────────────────────────────────────

interval:
  # Sweep interpolation tick
  - interval: 2s
    then:
      - lambda: |-
          // --- Sweep logic ---
          if (id(sweep_active)) {
            unsigned long now = millis();
            float elapsed_s = (float)(now - id(sweep_start_time)) / 1000.0f;
            float duration = (float)id(sweep_duration_sec);
            float t = elapsed_s / duration;
            if (t > 1.0f) t = 1.0f;

            id(sim_moisture_1) = id(sweep_start_1) +
              (int)((id(sweep_target_1) - id(sweep_start_1)) * t);
            id(sim_moisture_2) = id(sweep_start_2) +
              (int)((id(sweep_target_2) - id(sweep_start_2)) * t);
            id(sim_moisture_3) = id(sweep_start_3) +
              (int)((id(sweep_target_3) - id(sweep_start_3)) * t);

            // Update LVGL bars
            lv_bar_set_value(id(bar_sweep_1), id(sim_moisture_1), LV_ANIM_ON);
            lv_bar_set_value(id(bar_sweep_2), id(sim_moisture_2), LV_ANIM_ON);
            lv_bar_set_value(id(bar_sweep_3), id(sim_moisture_3), LV_ANIM_ON);

            // Update value labels
            char buf[8];
            snprintf(buf, sizeof(buf), "%d%%", id(sim_moisture_1));
            lv_label_set_text(id(lbl_sweep_val_1), buf);
            snprintf(buf, sizeof(buf), "%d%%", id(sim_moisture_2));
            lv_label_set_text(id(lbl_sweep_val_2), buf);
            snprintf(buf, sizeof(buf), "%d%%", id(sim_moisture_3));
            lv_label_set_text(id(lbl_sweep_val_3), buf);

            // Update time remaining
            int remaining = (int)(duration - elapsed_s);
            if (remaining < 0) remaining = 0;
            char tbuf[16];
            snprintf(tbuf, sizeof(tbuf), "%d:%02d left", remaining / 60, remaining % 60);
            lv_label_set_text(id(lbl_sweep_time), tbuf);

            // Force publish sensor updates
            id(moisture_1_percent).publish_state(id(sim_moisture_1));
            id(moisture_2_percent).publish_state(id(sim_moisture_2));
            id(moisture_3_percent).publish_state(id(sim_moisture_3));

            if (t >= 1.0f) {
              id(sweep_active) = false;
              lv_label_set_text(id(lbl_sweep_time), "DONE!");
            }
          }

          // --- Rain percolation simulation ---
          // Only runs after user explicitly starts rain sim
          if (id(rain_ever_started)) {
          // Soil params: {infiltration, percolation, retention, drain}
          static const float soil_params[4][4] = {
            {8.0f, 6.0f, 20.0f, 1.5f},  // 0: Sand
            {4.0f, 2.5f, 55.0f, 0.5f},  // 1: Loam
            {1.5f, 0.8f, 75.0f, 0.2f},  // 2: Clay
            {3.0f, 1.5f, 65.0f, 0.3f}   // 3: Silt
          };
          static const float precip_mult[4] = {0.3f, 1.0f, 2.0f, 4.0f};

          int st = id(soil_type);
          if (st < 0) st = 0; if (st > 3) st = 3;
          float infiltration = soil_params[st][0];
          float percolation  = soil_params[st][1];
          float retention    = soil_params[st][2];
          float drain_rate   = soil_params[st][3];

          int pr = id(precip_rate);
          if (pr < 0) pr = 0; if (pr > 3) pr = 3;
          float pmult = precip_mult[pr];
          float tf = id(time_factor);
          if (tf < 0.1f) tf = 0.1f;

          float &s3 = id(sim_moisture_f3);  // shallow
          float &s2 = id(sim_moisture_f2);  // mid
          float &s1 = id(sim_moisture_f1);  // deep

          if (id(rain_active)) {
            float effective_rain = infiltration * pmult * tf;

            // S3 (shallow) - receives rain directly
            s3 += effective_rain;
            if (s3 > retention) {
              float excess = (s3 - retention) * percolation / 100.0f * tf;
              s3 -= excess;
              id(s2_pending) += excess;
            }

            // S2 (mid) - receives percolation from S3
            float s2_intake = id(s2_pending) * (percolation / infiltration) * tf;
            s2 += s2_intake;
            id(s2_pending) -= s2_intake;
            if (id(s2_pending) < 0.01f) id(s2_pending) = 0.0f;
            if (s2 > retention) {
              float excess = (s2 - retention) * percolation / 100.0f * tf;
              s2 -= excess;
              id(s1_pending) += excess;
            }

            // S1 (deep) - receives percolation from S2
            float s1_intake = id(s1_pending) * (percolation / infiltration) * tf;
            s1 += s1_intake;
            id(s1_pending) -= s1_intake;
            if (id(s1_pending) < 0.01f) id(s1_pending) = 0.0f;
          } else {
            // Auto-dry: evaporation when not raining
            // Also drain any pending moisture
            float s2_intake = id(s2_pending) * (percolation / infiltration) * tf;
            s2 += s2_intake;
            id(s2_pending) -= s2_intake;
            if (id(s2_pending) < 0.01f) id(s2_pending) = 0.0f;

            float s1_intake = id(s1_pending) * (percolation / infiltration) * tf;
            s1 += s1_intake;
            id(s1_pending) -= s1_intake;
            if (id(s1_pending) < 0.01f) id(s1_pending) = 0.0f;

            s3 -= drain_rate * 1.0f * tf;   // shallow dries fastest
            s2 -= drain_rate * 0.6f * tf;   // mid dries slower
            s1 -= drain_rate * 0.3f * tf;   // deep dries slowest
          }

          // Clamp 0-100
          if (s3 < 0.0f) s3 = 0.0f; if (s3 > 100.0f) s3 = 100.0f;
          if (s2 < 0.0f) s2 = 0.0f; if (s2 > 100.0f) s2 = 100.0f;
          if (s1 < 0.0f) s1 = 0.0f; if (s1 > 100.0f) s1 = 100.0f;

          // Copy to int globals and publish
          id(sim_moisture_3) = (int)roundf(s3);
          id(sim_moisture_2) = (int)roundf(s2);
          id(sim_moisture_1) = (int)roundf(s1);

          // Update rain page bars if visible
          lv_bar_set_value(id(bar_rain_3), id(sim_moisture_3), LV_ANIM_ON);
          lv_bar_set_value(id(bar_rain_2), id(sim_moisture_2), LV_ANIM_ON);
          lv_bar_set_value(id(bar_rain_1), id(sim_moisture_1), LV_ANIM_ON);
          {
            char rb[8];
            snprintf(rb, sizeof(rb), "%d%%", id(sim_moisture_3));
            lv_label_set_text(id(lbl_rain_val_3), rb);
            snprintf(rb, sizeof(rb), "%d%%", id(sim_moisture_2));
            lv_label_set_text(id(lbl_rain_val_2), rb);
            snprintf(rb, sizeof(rb), "%d%%", id(sim_moisture_1));
            lv_label_set_text(id(lbl_rain_val_1), rb);
          }

          // Also update main page slider labels to reflect sim values
          {
            char mb[8];
            snprintf(mb, sizeof(mb), "%d%%", id(sim_moisture_1));
            lv_label_set_text(id(lbl_m1_val), mb);
            snprintf(mb, sizeof(mb), "%d%%", id(sim_moisture_2));
            lv_label_set_text(id(lbl_m2_val), mb);
            snprintf(mb, sizeof(mb), "%d%%", id(sim_moisture_3));
            lv_label_set_text(id(lbl_m3_val), mb);
          }

          // Publish to HA (rain sim values)
          id(moisture_1_percent).publish_state(id(sim_moisture_1));
          id(moisture_2_percent).publish_state(id(sim_moisture_2));
          id(moisture_3_percent).publish_state(id(sim_moisture_3));
          } // end rain_ever_started guard

          // --- Sleep wake-up timer ---
          if (id(sleep_sequence_active)) {
            unsigned long elapsed_ms = millis() - id(sleep_sequence_start_time);
            unsigned long sleep_ms = (unsigned long)id(sleep_duration_minutes) * 60UL * 1000UL;
            if (elapsed_ms >= sleep_ms) {
              id(sleep_sequence_active) = false;
              id(device_awake) = true;
              id(status_led_state) = true;
              // Turn virtual LED back on
              auto call = id(status_led).turn_on();
              call.perform();
              // Update UI labels
              lv_label_set_text(id(lbl_awake_status), "AWAKE");
              lv_obj_set_style_text_color(id(lbl_awake_status), lv_color_hex(0x00E676), 0);
              lv_label_set_text(id(lbl_sleep_btn), "SLEEP");
              lv_label_set_text(id(lbl_led_status), "LED: ON");
              lv_obj_set_style_text_color(id(lbl_led_status), lv_color_hex(0x00E676), 0);
            }
          }

# ──────────────────────────────────────────────
# LVGL UI
# ──────────────────────────────────────────────

lvgl:
  displays:
    - dial_lcd
  touchscreens:
    - touchscreen_id: touch
  encoders:
    - sensor: dial_encoder
      enter_button: dial_button
  color_depth: 16
  buffer_size: 10%
  default_font: montserrat_14
  disp_bg_color: 0x0D0D0D

  theme:
    button:
      focused:
        border_color: 0xFFFFFF
        border_width: 2
    slider:
      focused:
        border_color: 0xFFFFFF
        border_width: 2
      knob:
        edited:
          bg_color: 0xFF3D00
    buttonmatrix:
      focused:
        border_color: 0xFFFFFF
        border_width: 2

  style_definitions:
    - id: style_btn
      bg_color: 0x00E676
      radius: 8
      text_color: 0x0D0D0D
      pad_all: 6
    - id: style_btn_outline
      bg_color: 0x1A1A1A
      radius: 8
      border_width: 2
      border_color: 0x00E676
      text_color: 0x00E676
      pad_all: 6
    - id: style_btn_red
      bg_color: 0xFF3D00
      radius: 8
      text_color: 0xFFFFFF
      pad_all: 6

  pages:
    # ──────── PAGE: SPLASH ────────
    - id: page_splash
      bg_color: 0x0D0D0D
      widgets:
        - image:
            src: gophr_logo
            align: CENTER
            y: -25
        - label:
            text: "GOPHR"
            text_font: montserrat_28
            text_color: 0x00E676
            align: CENTER
            y: 45
        - label:
            text: "Moisture Simulator"
            text_font: montserrat_12
            text_color: 0x888888
            align: CENTER
            y: 68
        - label:
            id: lbl_splash_status
            text: "Starting..."
            text_font: montserrat_12
            text_color: 0x555555
            align: CENTER
            y: 88

    # ──────── PAGE: MAIN ────────
    - id: page_main
      bg_color: 0x0D0D0D
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_main));
      widgets:
        # Title row
        - label:
            text: "GOPHR SIM"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # Status row
        - label:
            id: lbl_awake_status
            text: "AWAKE"
            text_font: montserrat_10
            text_color: 0x00E676
            x: 30
            y: 36
        - label:
            id: lbl_led_status
            text: "LED: ON"
            text_font: montserrat_10
            text_color: 0x00E676
            align: TOP_RIGHT
            x: -30
            y: 36

        # --- Sensor 3: SHALLOW (top) ---
        - label:
            text: "S3"
            text_font: montserrat_10
            text_color: 0xFFAB00
            x: 22
            y: 52
        - slider:
            id: slider_m3
            x: 38
            y: 52
            width: 140
            height: 14
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00
            knob:
              bg_color: 0xFFFFFF
              radius: 7
              width: 14
              height: 14
            on_value:
              then:
                - lambda: 'id(sim_moisture_3) = (int)x;'
                - lvgl.label.update:
                    id: lbl_m3_val
                    text:
                      format: "%d%%"
                      args: ['(int)x']
        - label:
            id: lbl_m3_val
            text: "50%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 184
            y: 51

        # --- Sensor 2: MID (middle) ---
        - label:
            text: "S2"
            text_font: montserrat_10
            text_color: 0x00BFA5
            x: 22
            y: 74
        - slider:
            id: slider_m2
            x: 38
            y: 74
            width: 140
            height: 14
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5
            knob:
              bg_color: 0xFFFFFF
              radius: 7
              width: 14
              height: 14
            on_value:
              then:
                - lambda: 'id(sim_moisture_2) = (int)x;'
                - lvgl.label.update:
                    id: lbl_m2_val
                    text:
                      format: "%d%%"
                      args: ['(int)x']
        - label:
            id: lbl_m2_val
            text: "50%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 184
            y: 73

        # --- Sensor 1: DEEP (bottom) ---
        - label:
            text: "S1"
            text_font: montserrat_10
            text_color: 0x2979FF
            x: 22
            y: 96
        - slider:
            id: slider_m1
            x: 38
            y: 96
            width: 140
            height: 14
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF
            knob:
              bg_color: 0xFFFFFF
              radius: 7
              width: 14
              height: 14
            on_value:
              then:
                - lambda: 'id(sim_moisture_1) = (int)x;'
                - lvgl.label.update:
                    id: lbl_m1_val
                    text:
                      format: "%d%%"
                      args: ['(int)x']
        - label:
            id: lbl_m1_val
            text: "50%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 184
            y: 95

        # --- Send confirmation label (hidden by default) ---
        - label:
            id: lbl_send_confirm
            text: "SENT!"
            text_font: montserrat_12
            text_color: 0x00E676
            align: BOTTOM_MID
            y: -18
            hidden: true

        # --- Bottom buttons ---
        - button:
            id: btn_send
            x: 20
            y: 120
            width: 60
            height: 32
            styles: style_btn
            widgets:
              - label:
                  text: "SEND"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    id(moisture_1_percent).publish_state(id(sim_moisture_1));
                    id(moisture_2_percent).publish_state(id(sim_moisture_2));
                    id(moisture_3_percent).publish_state(id(sim_moisture_3));
                - lvgl.widget.show: lbl_send_confirm
                - delay: 1500ms
                - lvgl.widget.hide: lbl_send_confirm

        - button:
            id: btn_goto_sim
            x: 88
            y: 120
            width: 64
            height: 32
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SIM >"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_LEFT
                    time: 300ms

        - button:
            id: btn_sleep_toggle
            x: 160
            y: 120
            width: 64
            height: 32
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_sleep_btn
                  text: "SLEEP"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(device_awake)) {
                      id(device_awake) = false;
                      id(sleep_sequence_active) = true;
                      id(sleep_sequence_start_time) = millis();
                      lv_label_set_text(id(lbl_awake_status), "SLEEPING");
                      lv_obj_set_style_text_color(id(lbl_awake_status), lv_color_hex(0xFF3D00), 0);
                      lv_label_set_text(id(lbl_sleep_btn), "WAKE");
                    } else {
                      id(device_awake) = true;
                      id(sleep_sequence_active) = false;
                      lv_label_set_text(id(lbl_awake_status), "AWAKE");
                      lv_obj_set_style_text_color(id(lbl_awake_status), lv_color_hex(0x00E676), 0);
                      lv_label_set_text(id(lbl_sleep_btn), "SLEEP");
                    }
                - if:
                    condition:
                      lambda: 'return !id(device_awake);'
                    then:
                      - light.turn_off:
                          id: status_led
                      - lvgl.label.update:
                          id: lbl_led_status
                          text: "LED: OFF"
                      - lambda: |-
                          lv_obj_set_style_text_color(id(lbl_led_status), lv_color_hex(0xFF3D00), 0);
                    else:
                      - light.turn_on:
                          id: status_led
                      - lvgl.label.update:
                          id: lbl_led_status
                          text: "LED: ON"
                      - lambda: |-
                          lv_obj_set_style_text_color(id(lbl_led_status), lv_color_hex(0x00E676), 0);

    # ──────── PAGE: SWEEP CONFIG ────────
    - id: page_sweep_cfg
      bg_color: 0x0D0D0D
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_sweep_cfg));
      widgets:
        - label:
            text: "SWEEP CFG"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # --- S1 Target ---
        - label:
            text: "S1"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 38
        - slider:
            id: slider_sweep_t1
            x: 38
            y: 38
            width: 140
            height: 12
            min_value: 0
            max_value: 100
            value: 80
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF
            knob:
              bg_color: 0xFFFFFF
              radius: 6
            on_value:
              then:
                - lambda: 'id(sweep_target_1) = (int)x;'
                - lvgl.label.update:
                    id: lbl_st1
                    text:
                      format: "%d%%"
                      args: ['(int)x']
        - label:
            id: lbl_st1
            text: "80%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 37

        # --- S2 Target ---
        - label:
            text: "S2"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 56
        - slider:
            id: slider_sweep_t2
            x: 38
            y: 56
            width: 140
            height: 12
            min_value: 0
            max_value: 100
            value: 80
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5
            knob:
              bg_color: 0xFFFFFF
              radius: 6
            on_value:
              then:
                - lambda: 'id(sweep_target_2) = (int)x;'
                - lvgl.label.update:
                    id: lbl_st2
                    text:
                      format: "%d%%"
                      args: ['(int)x']
        - label:
            id: lbl_st2
            text: "80%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 55

        # --- S3 Target ---
        - label:
            text: "S3"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 74
        - slider:
            id: slider_sweep_t3
            x: 38
            y: 74
            width: 140
            height: 12
            min_value: 0
            max_value: 100
            value: 80
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00
            knob:
              bg_color: 0xFFFFFF
              radius: 6
            on_value:
              then:
                - lambda: 'id(sweep_target_3) = (int)x;'
                - lvgl.label.update:
                    id: lbl_st3
                    text:
                      format: "%d%%"
                      args: ['(int)x']
        - label:
            id: lbl_st3
            text: "80%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 73

        # --- Duration ---
        - label:
            id: lbl_duration_val
            text: "1m"
            text_font: montserrat_12
            text_color: 0x00E676
            align: TOP_MID
            y: 92

        - buttonmatrix:
            id: btnm_duration
            x: 25
            y: 106
            width: 190
            height: 26
            rows:
              - buttons:
                  - id: btn_d_30s
                    text: "30s"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 30;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "30s"
                  - id: btn_d_1m
                    text: "1m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 60;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "1m"
                  - id: btn_d_5m
                    text: "5m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 300;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "5m"
                  - id: btn_d_15m
                    text: "15m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 900;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "15m"
                  - id: btn_d_30m
                    text: "30m"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 1800;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "30m"
                  - id: btn_d_1h
                    text: "1h"
                    on_value:
                      then:
                        - lambda: 'id(sweep_duration_sec) = 3600;'
                        - lvgl.label.update:
                            id: lbl_duration_val
                            text: "1h"

        # --- Direction + Start row ---
        - button:
            id: btn_dir_up
            x: 30
            y: 140
            width: 44
            height: 24
            styles: style_btn
            widgets:
              - label:
                  text: "UP"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: 'id(sweep_direction_up) = true;'
        - button:
            id: btn_dir_down
            x: 80
            y: 140
            width: 52
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "DOWN"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(sweep_direction_up) = false;'
        - button:
            id: btn_start_sweep
            x: 140
            y: 140
            width: 72
            height: 24
            styles: style_btn
            widgets:
              - label:
                  text: "START>"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    if (id(sweep_direction_up)) {
                      id(sweep_start_1) = id(sim_moisture_1);
                      id(sweep_start_2) = id(sim_moisture_2);
                      id(sweep_start_3) = id(sim_moisture_3);
                    } else {
                      id(sweep_start_1) = id(sweep_target_1);
                      id(sweep_start_2) = id(sweep_target_2);
                      id(sweep_start_3) = id(sweep_target_3);
                      id(sweep_target_1) = 0;
                      id(sweep_target_2) = 0;
                      id(sweep_target_3) = 0;
                      id(sim_moisture_1) = id(sweep_start_1);
                      id(sim_moisture_2) = id(sweep_start_2);
                      id(sim_moisture_3) = id(sweep_start_3);
                    }
                    id(sweep_start_time) = millis();
                    id(sweep_active) = true;
                    // Cancel rain sim if running
                    id(rain_active) = false;
                    id(rain_ever_started) = false;
                    lv_bar_set_value(id(bar_sweep_1), id(sim_moisture_1), LV_ANIM_OFF);
                    lv_bar_set_value(id(bar_sweep_2), id(sim_moisture_2), LV_ANIM_OFF);
                    lv_bar_set_value(id(bar_sweep_3), id(sim_moisture_3), LV_ANIM_OFF);
                - lvgl.page.show:
                    id: page_sweep_run
                    animation: MOVE_LEFT
                    time: 300ms

        # --- Back ---
        - button:
            id: btn_back_sweep_cfg
            align: BOTTOM_MID
            y: -20
            width: 80
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_RIGHT
                    time: 300ms

    # ──────── PAGE: SWEEP RUNNING ────────
    - id: page_sweep_run
      bg_color: 0x0D0D0D
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_sweep_run));
      widgets:
        - label:
            text: "SWEEPING"
            text_font: montserrat_12
            text_color: 0x00E676
            align: TOP_MID
            y: 22
        - label:
            id: lbl_sweep_time
            text: "0:00"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            align: TOP_MID
            y: 38

        # --- S1 bar ---
        - label:
            text: "S1"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 58
        - bar:
            id: bar_sweep_1
            x: 38
            y: 58
            width: 140
            height: 12
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF
        - label:
            id: lbl_sweep_val_1
            text: "0%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 57

        # --- S2 bar ---
        - label:
            text: "S2"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 78
        - bar:
            id: bar_sweep_2
            x: 38
            y: 78
            width: 140
            height: 12
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5
        - label:
            id: lbl_sweep_val_2
            text: "0%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 77

        # --- S3 bar ---
        - label:
            text: "S3"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 98
        - bar:
            id: bar_sweep_3
            x: 38
            y: 98
            width: 140
            height: 12
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00
        - label:
            id: lbl_sweep_val_3
            text: "0%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 97

        # --- Cancel button ---
        - button:
            id: btn_cancel_sweep
            align: BOTTOM_MID
            y: -30
            width: 100
            height: 30
            styles: style_btn_red
            widgets:
              - label:
                  text: "CANCEL"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - lambda: 'id(sweep_active) = false;'
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_RIGHT
                    time: 300ms

    # ──────── PAGE: SIM MODE SELECT ────────
    - id: page_sim_select
      bg_color: 0x0D0D0D
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_sim_select));
      widgets:
        - label:
            text: "SIM MODE"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 28

        - button:
            id: btn_mode_sweep
            align: CENTER
            y: -20
            width: 170
            height: 40
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SWEEP"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_sweep_cfg
                    animation: MOVE_LEFT
                    time: 300ms

        - button:
            id: btn_mode_rain
            align: CENTER
            y: 30
            width: 170
            height: 40
            styles: style_btn
            widgets:
              - label:
                  text: "RAIN"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lvgl.page.show:
                    id: page_rain
                    animation: MOVE_LEFT
                    time: 300ms

        - button:
            id: btn_back_sim_select
            align: BOTTOM_MID
            y: -28
            width: 80
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_main
                    animation: MOVE_RIGHT
                    time: 300ms

    # ──────── PAGE: RAIN SIMULATION ────────
    - id: page_rain
      bg_color: 0x0D0D0D
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_rain));
      widgets:
        - label:
            text: "RAIN SIM"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # Rain status indicator
        - label:
            id: lbl_rain_status
            text: "STOPPED"
            text_font: montserrat_10
            text_color: 0xFF3D00
            align: TOP_MID
            y: 34

        # --- Soil type selector ---
        - buttonmatrix:
            id: btnm_soil
            x: 25
            y: 48
            width: 190
            height: 24
            rows:
              - buttons:
                  - id: btn_sand
                    text: "SND"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 0;'
                  - id: btn_loam
                    text: "LOM"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 1;'
                  - id: btn_clay
                    text: "CLY"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 2;'
                  - id: btn_silt
                    text: "SLT"
                    on_value:
                      then:
                        - lambda: 'id(soil_type) = 3;'

        # --- Precipitation rate selector ---
        - buttonmatrix:
            id: btnm_precip
            x: 25
            y: 76
            width: 190
            height: 24
            rows:
              - buttons:
                  - id: btn_drizzle
                    text: "DRIZ"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 0;'
                  - id: btn_rain_rate
                    text: "RAIN"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 1;'
                  - id: btn_heavy
                    text: "HEVY"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 2;'
                  - id: btn_pour
                    text: "POUR"
                    on_value:
                      then:
                        - lambda: 'id(precip_rate) = 3;'

        # --- Time factor ---
        - label:
            text: "1wk="
            text_font: montserrat_10
            text_color: 0x888888
            x: 25
            y: 106
        - slider:
            id: slider_time_factor
            x: 55
            y: 106
            width: 120
            height: 12
            min_value: 1
            max_value: 168
            value: 1
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00E676
            knob:
              bg_color: 0xFFFFFF
              radius: 6
            on_value:
              then:
                - lambda: |-
                    id(time_factor) = 168.0f / x;
                - lvgl.label.update:
                    id: lbl_time_factor
                    text:
                      format: "%dhr"
                      args: ['(int)x']
        - label:
            id: lbl_time_factor
            text: "1hr"
            text_font: montserrat_10
            text_color: 0x00E676
            x: 182
            y: 106

        # --- Live sensor bars ---
        - label:
            text: "S3"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 124
        - bar:
            id: bar_rain_3
            x: 38
            y: 124
            width: 140
            height: 10
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x2979FF
        - label:
            id: lbl_rain_val_3
            text: "50%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 122

        - label:
            text: "S2"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 140
        - bar:
            id: bar_rain_2
            x: 38
            y: 140
            width: 140
            height: 10
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00BFA5
        - label:
            id: lbl_rain_val_2
            text: "50%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 138

        - label:
            text: "S1"
            text_font: montserrat_10
            text_color: 0x888888
            x: 22
            y: 156
        - bar:
            id: bar_rain_1
            x: 38
            y: 156
            width: 140
            height: 10
            min_value: 0
            max_value: 100
            value: 50
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0xFFAB00
        - label:
            id: lbl_rain_val_1
            text: "50%"
            text_font: montserrat_10
            text_color: 0xFFFFFF
            x: 184
            y: 154

        # --- Bottom buttons ---
        - button:
            id: btn_back_rain
            x: 24
            y: 174
            width: 56
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    id(rain_active) = false;
                    id(rain_ever_started) = false;
                - lvgl.page.show:
                    id: page_sim_select
                    animation: MOVE_RIGHT
                    time: 300ms

        - button:
            id: btn_start_rain
            x: 88
            y: 174
            width: 64
            height: 24
            styles: style_btn
            widgets:
              - label:
                  text: "START"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    id(rain_active) = true;
                    id(rain_ever_started) = true;
                    // Cancel sweep if running
                    id(sweep_active) = false;
                    id(sim_moisture_f1) = (float)id(sim_moisture_1);
                    id(sim_moisture_f2) = (float)id(sim_moisture_2);
                    id(sim_moisture_f3) = (float)id(sim_moisture_3);
                - lvgl.label.update:
                    id: lbl_rain_status
                    text: "RAINING"
                - lambda: |-
                    lv_obj_set_style_text_color(id(lbl_rain_status), lv_color_hex(0x2979FF), 0);

        - button:
            id: btn_stop_rain
            x: 160
            y: 174
            width: 56
            height: 24
            styles: style_btn_red
            widgets:
              - label:
                  text: "STOP"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - lambda: 'id(rain_active) = false;'
                - lvgl.label.update:
                    id: lbl_rain_status
                    text: "DRYING"
                - lambda: |-
                    lv_obj_set_style_text_color(id(lbl_rain_status), lv_color_hex(0xFFAB00), 0);
